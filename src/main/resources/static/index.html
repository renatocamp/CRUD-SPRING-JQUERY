<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Frameset//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<meta name="viewport" content="width=device-width, initial-scale=1">
	<link
		href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
		rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
		crossorigin="anonymous">
		<title>Formulário de Cadastro de Usuário</title>
</head>

<body>
	<div class="container my-4">
		<nav class="navbar navbar-light bg-light">
		<div class="container-fluid">
			<span class="navbar-brand mb-0 h1">RENATO CAMPOS</span>
		</div>
		</nav>
		<!-- Formulário de Cadastro de Usuário -->
		<form action="" id="formCadastroUsuario">
			<div class="mb-3">
				<label for="id" class="form-label">ID</label> <input type="text"
					class="form-control" id="id" readonly="readonly">
			</div>
			<div class="mb-3">
				<label for="nome" class="form-label">Nome</label> <input type="text"
					class="form-control" id="nome" placeholder="Digite seu nome"
					required="required">
					<div class="invalid-feedback">Por favor, informe o nome</div>
			</div>
			<div class="mb-3">
				<label for="idade" class="form-label">Idade</label> <input
					type="number" class="form-control" id="idade"
					placeholder="Digite sua idade">
			</div>
		</form>

		<!-- Botões de Ação -->
		<div class="d-flex gap-2 mb-3">
			<button type="button" class="btn btn-primary" onclick="saveUser()">Enviar</button>
			<button type="button" class="btn btn-secondary" onclick="resetForm()">Novo
				Usuário</button>
			<button type="button" class="btn btn-primary" data-bs-toggle="modal"
				data-bs-target="#modalPesquisaUser">Pesquisar</button>
			<button type="button" class="btn btn-danger" onclick="deleteButton()">Deletar</button>
		</div>

		<!-- Alerta de Sucesso -->
		<div id="alertBox" class="alert alert-warning d-none" role="alert">
			<span id="alertMessage">Usuário Deletado com Sucesso!</span>
		</div>
	</div>

	<!-- Modal para Pesquisa de Usuário -->
	<div class="modal fade" id="modalPesquisaUser" tabindex="-1"
		aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">PESQUISAR
						USUÁRIO</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form>
						<div class="mb-3">
							<label for="nomeBusca" class="col-form-label">Informe o
								nome:</label> <input type="text" class="form-control" id="nomeBusca">
						</div>
						<button type="button" class="btn btn-primary"
							onclick="pesquisaUser()">Buscar</button>
					</form>

					<!-- Tabela de Resultados -->
					<div style="height: 300px; overflow:scroll;">
					<table class="table mt-3" id="tabelaResultado">
						<thead>
							<tr>
								<th scope="col">ID</th>
								<th scope="col">Nome</th>
								<th scope="col">Editar</th>
								<th scope="col">Deletar</th>
							</tr>
						</thead>
						<tbody>
							<!-- Linhas vinda do banco de dados -->
						</tbody>
					</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- JQUERY -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
		crossorigin="anonymous"></script>

	<!-- Bootstrap Bundle -->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>

	<!-- JavaScript Customizado -->
	<script type="text/javascript">
	
        function resetForm() {
            $('#formCadastroUsuario').trigger('reset'); // Aqui reseto o formulário através dos botões Pesquisar e Deletar
        }

        function pesquisaUser() {
            var nome = $("#nomeBusca").val();

            if (nome != null && nome.trim() != '') {
                $.ajax({
                    method: "GET",
                    url: "/training-project-restapi/usuarios/buscarPorNome",
                    data: { name: nome },
                    success: function(response) {
                        $("#tabelaResultado > tbody > tr").remove();
                        for (var i = 0; i < response.length; i++) {
                            $("#tabelaResultado > tbody").append(
                                `<tr id="${response[i].id}">
                                    <td>${response[i].id}</td>
                                    <td>${response[i].nome}</td>
                                    <td><button type="button" onclick="colocarEmEdicao(${response[i].id})" class="btn btn-primary">Ver</button></td>
                                    <td><button type="button" class="btn btn-danger" onclick="deleteUser(${response[i].id})">Delete</button></td>
                                </tr>`
                            );
                        }
                    }
                }).fail(function(xhr, status, errorThrown) {
                    alert("Erro ao buscar usuário: " + xhr.responseText);
                });
            }
        }

        function colocarEmEdicao(id) {
            $.ajax({
                method: "GET",
                url: "/training-project-restapi/usuarios/buscausuario",
                data: "userId=" + id,
                success: function(response) {
                    $("#id").val(response.id);
                    $("#nome").val(response.nome);
                    $("#idade").val(response.idade);
                    $("#modalPesquisaUser").modal('hide');
                }
            }).fail(function(xhr, status, errorThrown) {
                alert("Erro ao buscar usuário por ID: " + xhr.responseText);
            });
        }

        function deleteUser(id) {
        	
        	if (!id) {
                
                $("#alertMessage").text("Carregue os dados do usuário através do botão Pesquisar");
                $("#alertBox").removeClass("d-none").addClass("alert-danger");

                
                setTimeout(function() {
                    $("#alertBox").addClass("d-none");
                }, 5000);
                return;
            }
        	        	
        	if(confirm("Deseja realmente deletar o usuário?")){
        	
            $.ajax({
                method: "DELETE",
                url: "/training-project-restapi/usuarios/delete",
                data: "userId=" + id,
                success: function(response) {
                    $("#" + id).remove();
                    $("#alertMessage").text(response);
                    $("#alertBox").removeClass("d-none").addClass("alert-success");
                    
                    setTimeout(function() {
                        $("#alertBox").addClass("d-none");
                    }, 5000);
                }
            }).fail(function(xhr, status, errorThrown) {
                $("#alertMessage").text("Erro ao deletar usuário por ID: " + xhr.responseText);
                $("#alertBox").removeClass("d-none").addClass("alert-danger");
                
                setTimeout(function() {
                    $("#alertBox").addClass("d-none");
                }, 5000);
            });
          }
        }
        
		function deleteButton(){
			
			var id = $('#id').val();
			
			deleteUser(id);
			resetForm();
		}

        function saveUser() {
        	
			if (!nome && !idade) {
                
                $("#alertMessage").text("Preencha os campos Nome e Idade para cadastrar");
                $("#alertBox").removeClass("d-none").addClass("alert-danger");
                //$("#nome").focus(); Adicionar focus no campos onde precisa ser preenchido

                
                setTimeout(function() {
                    $("#alertBox").addClass("d-none");
                }, 5000);
                return;
            }
        	
            var id = $("#id").val();
            var nome = $("#nome").val();
            var idade = $("#idade").val();

            $.ajax({
                method: "POST",
                url: "/training-project-restapi/usuarios/signup",
                data: JSON.stringify({ id: id, nome: nome, idade: idade }),
                contentType: "application/json; charset=UTF-8",
                success: function(response) {
                    $("#id").val(response.id);

                    $("#alertMessage").text("Usuário salvo com sucesso!");
                    $("#alertBox").removeClass("d-none").addClass("alert-success");

                    setTimeout(function() {
                        $("#alertBox").addClass("d-none");
                    }, 5000);
                }
            }).fail(function(xhr, status, errorThrown) {
            	$("#alertMessage").text("Erro ao salvar usuário");
                $("#alertBox").removeClass("d-none").addClass("alert-success");
                
                setTimeout(function() {
                    $("#alertBox").addClass("d-none");
                }, 5000);
            });
        }
    </script>
</body>
</html>
